{$ondemand_update_options = [
0 => "Обновление только вручную",
60 => "Автоматически при каждом запросе",
3600 => "Автоматически, но не чаще чем раз в час",
86400 => "Автоматически, но не чаще чем раз в день",
604800 => "Автоматически, но не чаще чем раз в неделю"
]}
{$max_products_options = [
0 => _wp("All"),
15 => _wp("Last 15"),
25 => _wp("Last 25"),
50 => _wp("Last 50"),
100 => _wp("Last 100")
]
}
<div class="block double-padded" id="s-syrrss-form">
    <h1>{_wp("RSS Feed of Products")}</h1>
    <p>Это первый параграф. Самое главное правило программистов Webasyst — никогда не писать документацию.</p>
    
    {if $settlements}
        <form id="s-plugin-syrrss" method="post" action="?plugin=syrrss&module=run">
            <div class="fields form">

            {if $info.exists}
                <div class="field-group" style="border-bottom: 1px solid #ccc;">
                    <div class="field">
                        <div class="name bold">
                            <label for="s-plugin-syrrss-last-export">RSS-файл</label>
                        </div>
                        <div class="value">
                            <input id="s-plugin-syrrss-last-export" type="text" value="{$info.url|escape}" readonly="readonly" class="long bold large" style="width: 75% !important;">
                            <a href="{$info.url}?download=1" class="bold nowrap inline"><i class="icon16 download no-overhanging" style="margin-top: 0.4em;"></i>Скачать</a>
                            <p class="small">Файл обновлен: {$info.mtime|wa_datetime:"humandatetime"}</p>
                            <p class="small"><i class="icon10 yes"></i> Ссылка на RSS-файл является постоянной и не меняется при повторном экспорте товаров. Для включения автоматического экспорта товаров укажите период обновления с помощью настройки «Обновление файла» ниже и сохраните настройку, повторно экспортировав товары. Чтобы сделать ссылку недействительной, удалите профиль.</p>
                        </div>
                    </div>
                </div>
            {/if}

                <div class="field js-profile-description">
                    <div class="name">Название профиля</div>
                    <div class="value">
                        <input type="text" name="profile[name]" value="{$profile.name|escape}">
                        <input type="hidden" name="profile[id]" value="{$profile.id|default:'-1'}">
                    </div>
                </div>

                <div class="field-group">

                    <div class="field">
                        <div class="name">
                            <label for="s-plugin-syrrss-domain">Витрина</label>
                        </div>
                        {if count($settlements)>1}
                            <div class="value no-shift">
                                <select name="config[domain]" id="s-plugin-syrss-domain">
                                    {foreach $settlements as $route}
                                        <option value="{$route|escape}"{if $route eq $current_domain} selected="selected"{/if}>{$route|escape}</option>
                                    {/foreach}
                                </select>

                                <p class="hint">
                                    Витрину необходимо указать для
                                    правильного указания адресов страниц
                                    товаров в RSS-файле и отбора товаров
                                    для экспорта.
                                </p>
                            </div>
                        {elseif reset($settlements)}
                            <div class="value no-shift">
                                {$route = reset($settlements)}
                                <input type="text" readonly="readonly" value="{$route|escape}" name="config[domain]" id="s-plugin-syrrss-domain">

                                <p class="hint">
                                    Витрину необходимо указать для
                                    правильного указания адресов страниц
                                    товаров в RSS-файле и отбора товаров
                                    для экспорта.
                                </p>
                            </div>
                        {else}
                            <span class="errormsg">Не удалось обнаружить витрину магазина. Проверьте настройки поселения магазина.</span>
                        {/if}
                    </div>

                    <div class="field">
                        <div class="name">
                            <label for="s-plugin-syrrss-ondemand-update">Обновление файла</label>
                        </div>
                        <div class="value no-shift">
                            <select name="config[lifetime]" id="s-plugin-syrrss-ondemand-update">
                                {html_options options=$ondemand_update_options selected=$profile.config.lifetime}
                            </select>
                            <p class="hint">
                                Эта настройка позволяет включить
                                <em>повторный автоматический экспорт</em>
                                товаров в файл при запросе уникального адреса
                                (адрес формируется в момент первого экспорта
                                для каждого профиля). Обновление файла
                                выполняется каждый раз при запросе его
                                уникального адреса, если возраст файла
                                превышает выбранное значение. Если
                                автоматическое обновление не выбрано, то по
                                уникальному адресу файла всегда будет
                                отдаваться его последняя версия,
                                экспортированная вручную.
                            </p>
                        </div>
                    </div>

                </div>
                <div class="clear-left"></div>

                <div class="field-group">
                    <h2 class="gray">1. Выберите товары</h2>
                    {* Hash selection will be released next time *}
                    <input type="hidden" name="config[hash]" value="">
                    <div class="field">
                        <div class="name">
                            <label for="s-plugin-syrrss-max-products">{_wp("Maximum products in the feed")}</label>
                        </div>
                        <div class="value no-shift">
                            <select name="config[max_products]" id="s-plugin-syrrss-max-products">
                                {html_options options=$max_products_options selected=$profile.config.max_products}
                            </select>
                            <p class="hint">
                                Эта настройка позволяет указать
                                максимальное количество товаров,
                                экспортируемых в файл. Большинство
                                RSS-агрегаторов не загружают полностью
                                всю ленту, а только несколько
                                (обычно 10-15) последних записей.
                                Ограничение на количество
                                экспортируемых товаров поможет немного
                                уменьшить нагрузку на сервер при
                                обновлении файла с RSS-фидом.
                            </p>
                        </div>
                    </div>
                    <div class="clear-left"></div>
                </div>

                <div class="field-group">
                    <h2 class="gray">2. Общие параметры экспорта</h2>

                    <div class="field">
                        <div class="name"><label for="s-plugin-syrrss-channel-name">{_wp("Channel Name")}</label></div>
                        <div class="value">
                            <input type="text" name="config[channel_name]" placeholder="{_wp("Channel Name")}" value="{$profile.config.channel_name|escape}" id="s-plugin-syrrss-channel-name">

                            <p class="hint">Наименование канала RSS.</p>
                        </div>
                    </div>

                </div>
                <div class="clear-left"></div>
                
                <div class="field-group" id="plugin-syrrss-submit">
                    <div class="field">
                        <div class="value submit">
                            <button type="submit" class="button green">Экспортировать</button>
                            <br><br>
                            <em class="small js-profile-notice">При экспорте изменения в настройках профиля будут сохранены и применены к последующим экспортам автоматически</em>

                            <div class="js-progressbar-container" style="display:none;">
                                <div class="progressbar blue float-left" style="display: none; width: 70%;">
                                    <div class="progressbar-outer">
                                        <div class="progressbar-inner" style="width: 0;"></div>
                                    </div>
                                </div>
                                <img style="float:left; margin-top:8px;" src="{$wa_url}wa-content/img/loading32.gif"/>

                                <div class="clear"></div>
                                <span class="progressbar-description"></span>
                                <br style="clear:left;"/>
                                <br>
                                <span class="small italic">
                                    Не закрывайте окно браузера и не покидайте страницу до тех пор, пока процесс экспорта не будет завершен
                                </span>
                            </div>
                            <br><br>
                            <em class="errormsg"></em>
                        </div>
                    </div>
                </div>
                <div class="field-group" id="plugin-syrrss-report" style="display: none;">
                    <div class="field">
                        <div class="value"></div>
                        <div class="value"><br><a href="#/syrrss{if !empty($profile.id)}:{$profile.id}{/if}/" name="/syrrss/" onclick="window.location.reload();" class="bold">Получить ссылку на файл</a></div>
                    </div>
                </div>

            </div>
        </form>

    {else}
        <p>
            <span class="errormsg">Не определено ни одного поселения магазина.</span>
            Для работы модуля экспорта товаров в RSS необходимо создать хотя бы
            одно поселение магазина на сайте, чтобы правильно указывать адреса
            страниц товаров в XML-файле RSS-фида.
        </p>
    {/if}
</div>

<script type="text/javascript">
    if ($.importexport.plugins.syrrss) {
        $.importexport.plugins.syrrss.init();
    } else {
        $.getScript('{$wa_app_static_url}plugins/syrrss/js/script.js', function() {
            $.importexport.plugins.syrrss.init();
//            $.importexport.plugins.yandexmarket.initForm();
        });
    }
    $.importexport.profiles.set('syrrss',{$profiles|json_encode});
</script>